#!/bin/bash
set -e

case "$1" in
configure)
	LIB_DIR="/usr/share/distiller-platform-update/lib"
	PLATFORM_INFO="/etc/distiller-platform-info"
	VERSION_FILE="/usr/share/distiller-platform-update/VERSION"

	# Create directories
	mkdir -p /var/lib/distiller-platform-update
	mkdir -p /var/log/distiller-platform-update
	mkdir -p /var/backups/distiller-platform-update
	mkdir -p /media

	# Initialize platform info if needed
	if [ ! -f "$PLATFORM_INFO" ]; then
		platform=$("$LIB_DIR/platform-detect.sh")
		cat >"$PLATFORM_INFO" <<EOF
DISTILLER_PLATFORM_VERSION=$(cat "$VERSION_FILE")
DISTILLER_INSTALL_DATE=$(date -Iseconds)
DISTILLER_INSTALL_METHOD=apt
DISTILLER_PLATFORM=$platform
EOF
	fi

	# Run update orchestrator
	"$LIB_DIR/update-orchestrator.sh"
	;;

abort-upgrade | abort-remove | abort-deconfigure) ;;

*)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
